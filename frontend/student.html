<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - DanceAura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8e44ad; /* Purple */
            --secondary-color: #3498db; /* Blue */
            --success-color: #2ecc71; /* Green */
        }

        body {
            background: #f5f5f5;
            font-family: 'Inter', sans-serif;
        }

        /* Navbar Styling */
        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand, .nav-link {
            color: white !important;
            font-weight: 500;
        }

        .profile-header {
            background-color: var(--primary-color);
            color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-top: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .profile-header h2 {
            font-weight: 700;
        }

        .course-card {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 1.5rem;
            background: white;
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
            height: 100%;
        }
        .course-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .text-success.fw-bold {
            font-size: 0.9rem;
        }

        .progress-bar {
            background-color: var(--success-color);
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .level-progress {
            margin-bottom: 1.5rem;
        }

        .overall-progress {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="home1.html">DanceAura</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="home1.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="student.html">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="logout()">Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="profile-header">
        <h2>Welcome, <span id="studentName">Student Dancer</span>!</h2>
        <p>Your Dance Progress Dashboard</p>
    </div>

    <h3 class="mt-5 mb-3 text-dark">My Course Progress</h3>
    <div id="coursesList" class="row">
        <p id="loadingMessage" class="text-center">Loading progress data...</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Configuration
    const API_BASE_URL = 'http://localhost:5000/api/auth';
    const authToken = localStorage.getItem('authToken');
    const studentName = localStorage.getItem('studentName') || "Student Dancer";

    // --- Authentication Check ---
    if (!authToken) {
        window.location.href = "login.html"; 
    }

    // --- Student Name Display ---
    document.getElementById("studentName").textContent = studentName;

    // --- VIDEO COUNTS PER STYLE/LEVEL (Update this based on your actual video counts) ---
    const TOTAL_VIDEOS_PER_LEVEL = {
        'Ballet': { 
            'Beginner': 4, 
            'Intermediate': 4, 
            'Advanced': 4 
        },
        'Hip Hop': { 
            'Beginner': 5, 
            'Intermediate': 8, 
            'Advanced': 10 
        },
        'K Pop': { 
            'Beginner': 6, 
            'Intermediate': 8, 
            'Advanced': 12 
        },
        'Zumba': { 
            'Beginner': 5, 
            'Intermediate': 7, 
            'Advanced': 9 
        },
        'Salsa': { 
            'Beginner': 4, 
            'Intermediate': 6, 
            'Advanced': 8 
        },
        'Belly Dance': { 
            'Beginner': 5, 
            'Intermediate': 7, 
            'Advanced': 9 
        },
        'Bharatanatyam': { 
            'Beginner': 6, 
            'Intermediate': 8, 
            'Advanced': 10 
        },
        'Kuchipudi': { 
            'Beginner': 5, 
            'Intermediate': 7, 
            'Advanced': 9 
        },
        'Kathak': { 
            'Beginner': 6, 
            'Intermediate': 8, 
            'Advanced': 10 
        },
        'Dandiya': { 
            'Beginner': 4, 
            'Intermediate': 6, 
            'Advanced': 8 
        },
        'Garbha': { 
            'Beginner': 5, 
            'Intermediate': 7, 
            'Advanced': 9 
        },
        'Bhangra': { 
            'Beginner': 6, 
            'Intermediate': 8, 
            'Advanced': 10 
        },
        'Aerobics': { 
            'Beginner': 7, 
            'Intermediate': 7, 
            'Advanced': 10 
        }
    };

    // --- CORE FUNCTION: Fetch and Render Progress ---
    async function fetchAndRenderProgress() {
        const coursesContainer = document.getElementById("coursesList");
        const loadingMessage = document.getElementById("loadingMessage");
        
        // Show loading state
        coursesContainer.innerHTML = '';
        coursesContainer.appendChild(loadingMessage);

        try {
            // 1. Fetch User Progress from the Backend
            const response = await fetch(`${API_BASE_URL}/profile`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (!response.ok) {
                if (response.status === 401) { 
                    logout(); 
                    return; 
                }
                throw new Error('Failed to fetch progress data. Token expired or invalid.');
            }

            const data = await response.json();
            const userProgress = data.progress || {};
            
            // Remove loading message
            loadingMessage.remove();

            if (Object.keys(userProgress).length === 0) {
                coursesContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <h5>No Progress Yet!</h5>
                            <p>Start watching dance videos to track your progress here.</p>
                            <a href="home1.html" class="btn btn-primary mt-2">Explore Dance Styles</a>
                        </div>
                    </div>`;
                return;
            }

            let allCoursesHTML = '';

            // 2. Iterate through the fetched progress and render cards
            for (const [styleName, levels] of Object.entries(userProgress)) {
                const styleTotalVideos = TOTAL_VIDEOS_PER_LEVEL[styleName] || { 
                    'Beginner': 5, 'Intermediate': 8, 'Advanced': 10 
                };
                
                let levelHTML = '';
                let totalVideosWatched = 0;
                let totalVideosAvailable = 0;

                // Calculate progress for each level
                for (const [levelName, completedVideos] of Object.entries(levels)) {
                    const totalVideos = styleTotalVideos[levelName] || 5;
                    const videosCompletedCount = Array.isArray(completedVideos) ? completedVideos.length : 0;
                    
                    const progressPercent = Math.min(100, Math.round((videosCompletedCount / totalVideos) * 100));

                    totalVideosWatched += videosCompletedCount;
                    totalVideosAvailable += totalVideos;

                    levelHTML += `
                        <div class="level-progress mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold">${levelName}</span>
                                <small class="text-muted">${videosCompletedCount}/${totalVideos} videos</small>
                            </div>
                            <div class="progress" style="height: 12px;">
                                <div class="progress-bar ${progressPercent >= 100 ? 'bg-success' : 'bg-primary'}" 
                                    role="progressbar" style="width: ${progressPercent}%;" 
                                    aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">${progressPercent}% complete</small>
                        </div>
                    `;
                }

                const overallProgressPercent = totalVideosAvailable > 0 ? Math.round((totalVideosWatched / totalVideosAvailable) * 100) : 0;
                const courseName = styleName + " Dance";

                allCoursesHTML += `
                    <div class="col-lg-6 col-md-6 mb-4">
                        <div class="course-card">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h4 class="mb-0">${courseName}</h4>
                                <span class="badge bg-primary">${overallProgressPercent}%</span>
                            </div>
                            
                            <div class="overall-progress mb-3">
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-info" 
                                        role="progressbar" style="width: ${overallProgressPercent}%;">
                                    </div>
                                </div>
                                <small class="text-muted">Overall: ${totalVideosWatched}/${totalVideosAvailable} videos watched</small>
                            </div>
                            
                            <hr class="my-3">
                            
                            ${levelHTML}
                            
                            <div class="mt-3">
                                <a href="${getDanceStyleLink(styleName)}" class="btn btn-outline-primary btn-sm">
                                    Continue Learning
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }

            coursesContainer.innerHTML = allCoursesHTML;

        } catch (error) {
            console.error('Error in fetching or rendering progress:', error);
            loadingMessage.remove();
            coursesContainer.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <h5>Error Loading Progress</h5>
                        <p>${error.message}</p>
                        <button onclick="fetchAndRenderProgress()" class="btn btn-warning mt-2">Try Again</button>
                    </div>
                </div>`;
        }
    }

    // Helper function to get dance style page links
    function getDanceStyleLink(styleName) {
        const styleLinks = {
            'Ballet': 'ballet.html',
            'Hip Hop': 'videos.html',
            'K Pop': 'kpop.html',
            'Zumba': 'zumba.html',
            'Salsa': 'salsa.html',
            'Belly Dance': 'belly.html',
            'Bharatanatyam': 'bharatanatyam.html',
            'Kuchipudi': 'kuchipudi.html',
            'Kathak': 'kathak.html',
            'Dandiya': 'ddandiya.html',
            'Garbha': 'garba.html',
            'Bhangra': 'bhangra.html',
            'Aerobics': 'aerobics.html'
        };
        return styleLinks[styleName] || 'home1.html';
    }

    // --- Utility Function: Word Count ---
    function wordCount(text) {
        return text.trim().split(/\s+/).filter(word => word.length > 0).length;
    }

    // --- Feedback Submission Function ---
    async function submitFeedback(styleName) {
        const feedbackEl = document.getElementById(`feedback-${styleName}`);
        const feedbackText = feedbackEl.value.trim();
        const wordLen = wordCount(feedbackText);
        const submitBtn = document.getElementById(`submitBtn-${styleName}`);

        if (wordLen < 30 || wordLen > 50) {
            alert(`❌ Feedback must be between 30 to 50 words. You entered ${wordLen} words.`);
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
            // API Call to Submit Feedback
            const response = await fetch(`${API_BASE_URL}/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ styleName, feedbackText })
            });
            
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Failed to submit feedback.');
            }
            
            alert("✅ Feedback successfully submitted! Your certificate is now available.");
            
            // Re-run the render function to update the card state fully
            fetchAndRenderProgress(); 

        } catch (error) {
            alert(`❌ Submission Error: ${error.message}`);
            console.error('Feedback Submission Error:', error);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Feedback';
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-primary');
        }
    }

    // --- Certificate Generation Function ---
    function generateCertificate(courseName) {
        const today = new Date();
        const formattedDate = today.toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' });

        const certHTML = `
            <html>
            <head>
                <title>DanceAura Certificate</title>
                <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
                <style>
                    body { font-family: sans-serif; padding: 0; margin: 0; background: #fff; }
                    .certificate {
                        width: 100%;
                        height: 100vh;
                        padding: 60px;
                        text-align: center;
                        position: relative;
                        box-sizing: border-box;
                        border: 20px solid transparent;
                        border-image: linear-gradient(to bottom right, #8e44ad, #9b59b6) 1;
                        box-shadow: 0 0 20px rgba(0,0,0,0.15);
                    }
                    .certificate-header h1 {
                        font-family: 'Great Vibes', cursive;
                        font-size: 50px;
                        color: #8e44ad;
                        margin-bottom: 30px;
                    }
                    h2 {
                        font-size: 36px;
                        margin-bottom: 10px;
                        font-weight: 600;
                        color: #333;
                    }
                    p {
                        font-size: 18px;
                        margin: 15px 0;
                        color: #555;
                    }
                    strong {
                        font-size: 28px;
                        font-family: 'Great Vibes', cursive;
                        color: #8e44ad;
                        display: block;
                        margin: 20px 0;
                    }
                    .signature-area {
                        display: flex;
                        justify-content: space-around;
                        align-items: flex-end;
                        margin-top: 80px;
                    }
                    .signature-block {
                        text-align: center;
                        border-top: 2px solid #8e44ad;
                        padding-top: 10px;
                    }
                    .instructor-name {
                        font-family: 'Great Vibes', cursive;
                        font-size: 30px;
                        margin: 0;
                        color: #8e44ad;
                    }
                    .date-block {
                        position: absolute;
                        bottom: 60px;
                        left: 60px;
                        font-weight: bold;
                        font-size: 16px;
                    }
                    @page {
                        size: landscape;
                        margin: 0;
                    }
                </style>
            </head>
            <body>
                <div class="certificate-print-area">
                    <div class="certificate">
                        <div class="certificate-header">
                            <h1>DanceAura</h1>
                        </div>
                        <h2>CERTIFICATE OF COMPLETION</h2>
                        <p>This certificate is proudly presented to</p>
                        <strong>${studentName}</strong>
                        <p>for gracefully completing the **Dance Style Learning Program**</p>
                        <p>with a specialization in **${courseName}**</p>
                        <p>and for demonstrating dedication, rhythm, and expressive performance throughout the course.</p>
                        <p style="font-weight: bold; margin-top: 40px;">Achieved Grade: A</p>
                        
                        <div class="signature-area">
                            <div class="signature-block">
                                <p class="instructor-name">Samantha Roy</p>
                                <p style="font-size: 16px; margin: 0;">Course Instructor</p>
                            </div>
                        </div>

                        <div class="date-block">
                            Date: ${formattedDate}
                        </div>
                    </div>
                </div>
                <script>
                    setTimeout(() => { window.print(); window.close(); }, 500);
                <\/script>
            </body>
            </html>
        `;

        const certWindow = window.open("", "_blank");
        if (certWindow) {
            certWindow.document.write(certHTML);
            certWindow.document.close();
        } else {
            alert("❌ Popup blocker prevented the certificate window from opening.");
        }
    }
    
    // --- Logout Function ---
    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('studentName');
        window.location.href = "login.html";
    }

    // --- Run the fetch function on page load ---
    document.addEventListener('DOMContentLoaded', fetchAndRenderProgress);

    // Optional: Refresh progress every 30 seconds if needed
    // setInterval(fetchAndRenderProgress, 30000);
</script>

</body>
</html>